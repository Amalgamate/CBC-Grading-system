import axiosInstance, { API_BASE_URL } from './axiosConfig';

export { API_BASE_URL };

/**
 * Helper function to make authenticated requests using Axios
 */
const fetchWithAuth = async (url, options = {}) => {
  try {
    const config = {
      url,
      method: options.method || 'GET',
      data: options.body ? JSON.parse(options.body) : options.data,
      headers: options.headers || {},
      params: options.params,
    };

    // If body is FormData, don't parse it
    if (options.body instanceof FormData) {
      config.data = options.body;
      delete config.headers['Content-Type'];
    }

    const response = await axiosInstance(config);
    return response.data;
  } catch (error) {
    // Axios interceptors handle 401 and refresh
    if (error.response?.data) {
      const data = error.response.data;
      let msg = data.message || data.error || `HTTP ${error.response.status}`;
      throw new Error(msg);
    }
    throw error;
  }
};

// Simple In-Memory Cache for GET requests
const dataCache = new Map();
const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

/**
 * Fetch data with basic caching for non-volatile read operations
 */
const fetchCached = async (url, options = {}) => {
  const cacheKey = `${url}-${JSON.stringify(options.params || {})}`;
  const now = Date.now();

  if (dataCache.has(cacheKey)) {
    const { data, timestamp } = dataCache.get(cacheKey);
    if (now - timestamp < CACHE_TTL) {
      return data;
    }
    dataCache.delete(cacheKey);
  }

  const result = await fetchWithAuth(url, options);
  dataCache.set(cacheKey, { data: result, timestamp: now });
  return result;
};

/**
 * Clear specific or all cache
 */
export const clearApiCache = (key) => {
  if (key) dataCache.delete(key);
  else dataCache.clear();
};

// ============================================
// AUTHENTICATION ENDPOINTS
// ============================================

export const authAPI = {
  /**
   * Login user
   * @param {Object} credentials - { email, password }
   * @returns {Promise} User data and token
   */
  login: async (credentials) => {
    const response = await axiosInstance.post('/auth/login', credentials);
    return response.data;
  },
  /**
   * Fetch public tenant branding info.
   * @param {string} schoolId
   */
  tenantPublic: async (schoolId) => {
    const response = await axiosInstance.get(`/tenants/public/${schoolId}`);
    return response.data;
  },

  /**
   * Register new user
   * @param {Object} userData - User registration data
   * @returns {Promise} User data and token
   */
  register: async (userData) => {
    const response = await axiosInstance.post('/auth/register', userData);
    return response.data;
  },

  /**
   * Check availability of email/phone
   * @param {Object} data - { email, phone }
   * @returns {Promise} Availability status
   */
  checkAvailability: async (data) => {
    const response = await axiosInstance.post('/auth/check-availability', data);
    return response.data;
  },

  /**
   * Get current user profile
   * @returns {Promise} Current user data
   */
  me: async () => {
    return fetchWithAuth('/auth/me');
  },

  /**
   * Get seeded development users
   * @returns {Promise} List of seeded users
   */
  getSeededUsers: async () => {
    try {
      const response = await axiosInstance.get('/auth/seeded-users');
      return response.data;
    } catch (error) {
      return { users: [] };
    }
  },

  /**
   * Reset Password
   */
  resetPassword: async (token, password) => {
    return fetchWithAuth('/auth/reset-password', {
      method: 'POST',
      body: JSON.stringify({ token, password }),
    });
  },

  /**
   * Send OTP to user's phone
   * @param {Object} data - { email }
   * @returns {Promise} Confirmation message
   */
  sendOTP: async (data) => {
    const response = await axiosInstance.post('/auth/otp/send', data);
    return response.data;
  },

  /**
   * Verify OTP code
   * @param {Object} data - { email, otp }
   * @returns {Promise} User data and token
   */
  verifyOTP: async (data) => {
    const response = await axiosInstance.post('/auth/otp/verify', data);
    return response.data;
  },

  /**
   * Get CSRF token
   */
  getCsrf: async () => {
    const response = await axiosInstance.get('/auth/csrf');
    return response.data;
  },
};

/**
 * Onboarding Endpoints
 */
export const onboardingAPI = {
  /**
   * Full school registration
   */
  registerFull: async (data) => {
    // Get CSRF token first
    const { token: csrfToken } = await authAPI.getCsrf();

    const response = await axiosInstance.post('/onboarding/register-full', data, {
      headers: {
        'X-CSRF-Token': csrfToken,
      },
    });

    return response.data;
  },
};

// ============================================
// DASHBOARD API
// ============================================

export const dashboardAPI = {
  /**
   * Get Admin Dashboard metrics
   */
  getAdminMetrics: async (filter = 'today') => {
    return fetchWithAuth(`/dashboard/admin?filter=${filter}`);
  },

  /**
   * Get Teacher Dashboard metrics
   */
  getTeacherMetrics: async (filter = 'today') => {
    return fetchWithAuth(`/dashboard/teacher?filter=${filter}`);
  }
};

// ============================================
// CONFIGURATION ENDPOINTS
// ============================================

export const configAPI = {
  /**
   * Get Term Configurations for a school
   */
  getTermConfigs: async (schoolId) => {
    return fetchWithAuth(`/config/term/${schoolId}`);
  },

  /**
   * Create or Update Term Configuration
   */
  upsertTermConfig: async (data) => {
    return fetchWithAuth('/config/term', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  /**
   * Get Aggregation Configurations
   */
  getAggregationConfigs: async (schoolId) => {
    return fetchWithAuth(`/config/aggregation/${schoolId}`);
  },

  /**
   * Create Aggregation Configuration
   */
  createAggregationConfig: async (data) => {
    return fetchWithAuth('/config/aggregation', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  /**
   * Update Aggregation Configuration
   */
  updateAggregationConfig: async (id, data) => {
    return fetchWithAuth(`/config/aggregation/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  },

  /**
   * Delete Aggregation Configuration
   */
  deleteAggregationConfig: async (id) => {
    return fetchWithAuth(`/config/aggregation/${id}`, {
      method: 'DELETE',
    });
  },

  /**
   * Get Stream Configurations
   */
  getStreamConfigs: async (schoolId) => {
    return fetchWithAuth(`/config/streams/${schoolId}`, {
      headers: {
        'X-School-Id': schoolId,
      },
    });
  },

  /**
   * Create or Update Stream Configuration
   */
  upsertStreamConfig: async (data) => {
    return fetchWithAuth('/config/streams', {
      method: 'POST',
      headers: {
        'X-School-Id': data.schoolId,
      },
      body: JSON.stringify(data),
    });
  },

  /**
   * Delete Stream Configuration
   */
  deleteStreamConfig: async (id) => {
    return fetchWithAuth(`/config/streams/${id}`, {
      method: 'DELETE',
    });
  },


  /**
   * Get all available grades (Enum)
   */
  getGrades: async () => {
    return fetchWithAuth('/config/grades');
  },

  /**
   * Get Branding and School Settings
   */
  getBranding: async () => {
    return fetchCached('/settings/branding');
  },

  /**
   * Get Classes for a school
   */
  getClasses: async (schoolId) => {
    return fetchWithAuth(`/config/classes/${schoolId}`);
  },

  /**
   * Create or Update Class
   */
  upsertClass: async (data) => {
    return fetchWithAuth('/config/classes', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  /**
   * Delete Class
   */
  deleteClass: async (id) => {
    return fetchWithAuth(`/config/classes/${id}`, {
      method: 'DELETE',
    });
  },

  /**
   * Get Learning Areas for a school
   */
  getLearningAreas: async (schoolId) => {
    return fetchWithAuth(`/learning-areas?schoolId=${schoolId}`);
  },

  /**
   * Get a specific learning area
   */
  getLearningArea: async (id) => {
    return fetchWithAuth(`/learning-areas/${id}`);
  },

  /**
   * Create a learning area
   */
  createLearningArea: async (data) => {
    return fetchWithAuth('/learning-areas', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  /**
   * Update a learning area
   */
  updateLearningArea: async (id, data) => {
    return fetchWithAuth(`/learning-areas/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  },

  /**
   * Delete a learning area
   */
  deleteLearningArea: async (id) => {
    return fetchWithAuth(`/learning-areas/${id}`, {
      method: 'DELETE',
    });
  },

  /**
   * Seed default learning areas
   */
  seedLearningAreas: async () => {
    return fetchWithAuth('/learning-areas/seed/default', {
      method: 'POST',
    });
  },

  /**
   * Seed default classes
   */
  seedClasses: async () => {
    return fetchWithAuth('/config/classes/seed', {
      method: 'POST',
    });
  },

  /**
   * Seed default streams
   */
  seedStreams: async () => {
    return fetchWithAuth('/config/streams/seed', {
      method: 'POST',
    });
  },
};

// ============================================
// COMMUNICATION API
// ============================================

export const communicationAPI = {
  /**
   * Get Communication Config
   */
  getConfig: async (schoolId) => {
    return fetchWithAuth(`/communication/config/${schoolId}`);
  },

  /**
   * Save Communication Config
   */
  saveConfig: async (data) => {
    return fetchWithAuth('/communication/config', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  /**
   * Send Test SMS
   */
  sendTestSMS: async (data) => {
    return fetchWithAuth('/communication/test/sms', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  /**
   * Send Test Email
   */
  sendTestEmail: async (data) => {
    return fetchWithAuth('/communication/test/email', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  /**
   * Get Birthdays Today
   */
  getBirthdaysToday: async (schoolId) => {
    return fetchWithAuth(`/communication/birthdays/today/${schoolId}`);
  },

  /**
   * Send Birthday Wishes
   */
  sendBirthdayWishes: async (data) => {
    return fetchWithAuth('/communication/birthdays/send', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },
};

// ============================================
// USER MANAGEMENT ENDPOINTS
// ============================================

export const userAPI = {
  /**
   * Get all users
   * @param {string} schoolId - Optional school ID to filter users (for Super Admin)
   * @returns {Promise} List of all users
   */
  getAll: async (schoolId) => {
    const params = schoolId ? `?schoolId=${schoolId}` : '';
    return fetchWithAuth(`/users${params}`);
  },

  /**
   * Get user by ID
   * @param {string} id - User ID
   * @returns {Promise} User data
   */
  getById: async (id) => {
    return fetchWithAuth(`/users/${id}`);
  },

  /**
   * Get users by role
   * @param {string} role - User role
   * @param {Object} params - Query parameters (page, limit)
   * @returns {Promise} List of users with specified role
   */
  getByRole: async (role, params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/users/role/${role}${queryString ? `?${queryString}` : ''}`);
  },

  /**
   * Get user statistics
   * @returns {Promise} User statistics for dashboard
   */
  getStats: async () => {
    return fetchWithAuth('/users/stats');
  },

  /**
   * Create new user
   * @param {Object} userData - User data
   * @returns {Promise} Created user data
   */
  create: async (userData) => {
    return fetchWithAuth('/users', {
      method: 'POST',
      body: JSON.stringify(userData),
    });
  },

  /**
   * Update user
   * @param {string} id - User ID
   * @param {Object} userData - Updated user data
   * @returns {Promise} Updated user data
   */
  update: async (id, userData) => {
    return fetchWithAuth(`/users/${id}`, {
      method: 'PUT',
      body: JSON.stringify(userData),
    });
  },

  /**
   * Archive user (soft delete)
   * @param {string} id - User ID
   * @returns {Promise} Success message
   */
  archive: async (id) => {
    return fetchWithAuth(`/users/${id}/archive`, {
      method: 'POST',
    });
  },

  /**
   * Unarchive user
   * @param {string} id - User ID
   * @returns {Promise} Success message
   */
  unarchive: async (id) => {
    return fetchWithAuth(`/users/${id}/unarchive`, {
      method: 'POST',
    });
  },

  /**
   * Delete user (hard delete)
   * @param {string} id - User ID
   * @returns {Promise} Success message
   */
  delete: async (id) => {
    return fetchWithAuth(`/users/${id}`, {
      method: 'DELETE',
    });
  },

  /**
   * Upload user profile photo
   * @param {string} id - User ID
   * @param {string} photoData - Base64 encoded image
   * @returns {Promise} Updated user data
   */
  uploadPhoto: async (id, photoData) => {
    return fetchWithAuth(`/users/${id}/photo`, {
      method: 'POST',
      body: JSON.stringify({ photoData }),
    });
  },
};

// ============================================
// SCHOOL MANAGEMENT ENDPOINTS
// ============================================

export const schoolAPI = {
  /**
   * Get all schools
   * @returns {Promise} List of all schools
   */
  getAll: async () => {
    return fetchWithAuth('/schools');
  },

  /**
   * Get school by ID
   * @param {string} id - School ID
   * @returns {Promise} School data
   */
  getById: async (id) => {
    return fetchWithAuth(`/schools/${id}`);
  },

  /**
   * Get branches for a school
   * @param {string} schoolId - School ID
   * @returns {Promise} List of branches
   */
  getBranches: async (schoolId) => {
    return fetchWithAuth(`/schools/${schoolId}/branches`);
  },
  /**
   * Create a new school
   */
  create: async (data) => {
    return fetchWithAuth('/schools', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },
  /**
   * Update school
   */
  update: async (id, data) => {
    return fetchWithAuth(`/schools/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  },
  /**
   * Deactivate school
   */
  deactivate: async (id) => {
    return fetchWithAuth(`/schools/${id}/deactivate`, {
      method: 'POST',
      headers: {
        'X-School-Id': id,
      },
    });
  },
  /**
   * Delete school
   */
  delete: async (id) => {
    return fetchWithAuth(`/schools/${id}`, {
      method: 'DELETE',
      headers: {
        'X-School-Id': id,
      },
    });
  },

  /**
   * Provision a new school with admin user (complete setup)
   */
  provision: async (data) => {
    return fetchWithAuth('/schools/provision', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },
};

// ============================================
// TEACHERS API (alias to userAPI.getByRole)
// ============================================

export const teacherAPI = {
  /**
   * Get all teachers
   * @returns {Promise} List of teachers
   */
  getAll: async () => {
    return userAPI.getByRole('TEACHER');
  },

  /**
   * Create new teacher
   * @param {Object} teacherData - Teacher data
   * @returns {Promise} Created teacher data
   */
  create: async (teacherData) => {
    return userAPI.create({ ...teacherData, role: 'TEACHER' });
  },

  /**
   * Update teacher
   * @param {string} id - Teacher ID
   * @param {Object} teacherData - Updated teacher data
   * @returns {Promise} Updated teacher data
   */
  update: async (id, teacherData) => {
    return userAPI.update(id, teacherData);
  },

  /**
   * Delete teacher
   * @param {string} id - Teacher ID
   * @returns {Promise} Success message
   */
  delete: async (id) => {
    return userAPI.delete(id);
  },
};

// ============================================
// PARENTS API (alias to userAPI.getByRole)
// ============================================

export const parentAPI = {
  /**
   * Get all parents
   * @param {Object} params - Query parameters (page, limit)
   * @returns {Promise} List of parents
   */
  getAll: async (params = {}) => {
    return userAPI.getByRole('PARENT', params);
  },

  /**
   * Create new parent
   * @param {Object} parentData - Parent data
   * @returns {Promise} Created parent data
   */
  create: async (parentData) => {
    return userAPI.create({ ...parentData, role: 'PARENT' });
  },

  /**
   * Update parent
   * @param {string} id - Parent ID
   * @param {Object} parentData - Updated parent data
   * @returns {Promise} Updated parent data
   */
  update: async (id, parentData) => {
    return userAPI.update(id, parentData);
  },

  /**
   * Archive parent (soft delete)
   * @param {string} id - Parent ID
   * @returns {Promise} Success message
   */
  archive: async (id) => {
    return userAPI.archive(id);
  },

  /**
   * Unarchive parent
   * @param {string} id - Parent ID
   * @returns {Promise} Success message
   */
  unarchive: async (id) => {
    return userAPI.unarchive(id);
  },

  /**
   * Delete parent (hard delete)
   * @param {string} id - Parent ID
   * @returns {Promise} Success message
   */
  delete: async (id) => {
    return userAPI.delete(id);
  },
};

// ============================================
// LEARNERS API
// ============================================

export const learnerAPI = {
  /**
   * Get all learners
   * @param {Object} params - Query parameters (grade, stream, status, search, page, limit)
   * @returns {Promise} List of learners
   */
  getAll: async (params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/learners${queryString ? `?${queryString}` : ''}`);
  },
  /**
   * Get upcoming birthdays
   */
  getBirthdays: async () => {
    return fetchWithAuth('/learners/birthdays/upcoming');
  },

  /**
   * Get learner statistics
   * @returns {Promise} Learner statistics
   */
  getStats: async () => {
    return fetchWithAuth('/learners/stats');
  },

  /**
   * Get learner by ID
   * @param {string} id - Learner ID
   * @returns {Promise} Learner data
   */
  getById: async (id) => {
    return fetchWithAuth(`/learners/${id}`);
  },

  /**
   * Get learner by admission number
   * @param {string} admissionNumber - Admission number
   * @returns {Promise} Learner data
   */
  getByAdmissionNumber: async (admissionNumber) => {
    return fetchWithAuth(`/learners/admission/${admissionNumber}`);
  },

  /**
   * Get learners by grade
   * @param {string} grade - Grade level
   * @param {Object} params - Additional params (stream, status)
   * @returns {Promise} List of learners
   */
  getByGrade: async (grade, params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/learners/grade/${grade}${queryString ? `?${queryString}` : ''}`);
  },

  /**
   * Get parent's children
   * @param {string} parentId - Parent user ID
   * @returns {Promise} List of children
   */
  getParentChildren: async (parentId) => {
    return fetchWithAuth(`/learners/parent/${parentId}`);
  },

  /**
   * Create new learner
   * @param {Object} learnerData - Learner data
   * @returns {Promise} Created learner data
   */
  create: async (learnerData) => {
    return fetchWithAuth('/learners', {
      method: 'POST',
      body: JSON.stringify(learnerData),
    });
  },

  /**
   * Update learner
   * @param {string} id - Learner ID
   * @param {Object} learnerData - Updated learner data
   * @returns {Promise} Updated learner data
   */
  update: async (id, learnerData) => {
    return fetchWithAuth(`/learners/${id}`, {
      method: 'PUT',
      body: JSON.stringify(learnerData),
    });
  },

  /**
   * Delete learner
   * @param {string} id - Learner ID
   * @returns {Promise} Success message
   */
  delete: async (id) => {
    return fetchWithAuth(`/learners/${id}`, {
      method: 'DELETE',
    });
  },

  /**
   * Upload learner photo
   * @param {string} id - Learner ID
   * @param {string} photoData - Base64 encoded image
   * @returns {Promise} Updated learner data
   */
  uploadPhoto: async (id, photoData) => {
    return fetchWithAuth(`/learners/${id}/photo`, {
      method: 'POST',
      body: JSON.stringify({ photoData }),
    });
  },
};

// ============================================
// CLASSES API
// ============================================

export const classAPI = {
  /**
   * Get all classes
   * @param {Object} params - Query parameters (grade, stream, academicYear, term, active)
   * @returns {Promise} List of classes
   */
  getAll: async (params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/classes${queryString ? `?${queryString}` : ''}`);
  },

  /**
   * Get class by ID
   * @param {string} id - Class ID
   * @returns {Promise} Class data with enrolled learners
   */
  getById: async (id) => {
    return fetchWithAuth(`/classes/${id}`);
  },

  /**
   * Create new class
   * @param {Object} classData - Class data
   * @returns {Promise} Created class data
   */
  create: async (classData) => {
    return fetchWithAuth('/classes', {
      method: 'POST',
      body: JSON.stringify(classData),
    });
  },

  /**
   * Update class
   * @param {string} id - Class ID
   * @param {Object} classData - Updated class data
   * @returns {Promise} Updated class data
   */
  update: async (id, classData) => {
    return fetchWithAuth(`/classes/${id}`, {
      method: 'PUT',
      body: JSON.stringify(classData),
    });
  },

  /**
   * Enroll learner in class
   * @param {string} classId - Class ID
   * @param {string} learnerId - Learner ID
   * @returns {Promise} Enrollment data
   */
  enrollLearner: async (classId, learnerId) => {
    return fetchWithAuth('/classes/enroll', {
      method: 'POST',
      body: JSON.stringify({ classId, learnerId }),
    });
  },

  /**
   * Unenroll learner from class
   * @param {string} classId - Class ID
   * @param {string} learnerId - Learner ID
   * @returns {Promise} Success message
   */
  unenrollLearner: async (classId, learnerId) => {
    return fetchWithAuth('/classes/unenroll', {
      method: 'POST',
      body: JSON.stringify({ classId, learnerId }),
    });
  },

  /**
   * Get learner's current class
   * @param {string} learnerId - Learner ID
   * @returns {Promise} Class enrollment data
   */
  getLearnerClass: async (learnerId) => {
    return fetchWithAuth(`/classes/learner/${learnerId}`);
  },

  /**
   * Assign teacher to class (dedicated endpoint)
   * @param {string} classId - Class ID
   * @param {string} teacherId - Teacher ID
   * @returns {Promise} Updated class data
   */
  assignTeacher: async (classId, teacherId) => {
    return fetchWithAuth('/classes/assign-teacher', {
      method: 'POST',
      body: JSON.stringify({ classId, teacherId }),
    });
  },

  /**
   * Unassign teacher from class
   * @param {string} classId - Class ID
   * @returns {Promise} Success message
   */
  unassignTeacher: async (classId) => {
    return fetchWithAuth('/classes/unassign-teacher', {
      method: 'POST',
      body: JSON.stringify({ classId }),
    });
  },

  /**
   * Get teacher's workload
   * @param {string} teacherId - Teacher ID
   * @param {Object} params - Query parameters (academicYear, term)
   * @returns {Promise} Teacher workload data
   */
  getTeacherWorkload: async (teacherId, params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/classes/teacher/${teacherId}/workload${queryString ? `?${queryString}` : ''}`);
  },
};

// ============================================
// ATTENDANCE API
// ============================================

export const attendanceAPI = {
  /**
   * Mark attendance for a single learner
   * @param {Object} attendanceData - { learnerId, date, status, classId, remarks }
   * @returns {Promise} Attendance record
   */
  mark: async (attendanceData) => {
    return fetchWithAuth('/attendance', {
      method: 'POST',
      body: JSON.stringify(attendanceData),
    });
  },

  /**
   * Mark attendance for multiple learners (bulk)
   * @param {Object} bulkData - { date, classId, attendanceRecords }
   * @returns {Promise} Bulk operation results
   */
  markBulk: async (bulkData) => {
    return fetchWithAuth('/attendance/bulk', {
      method: 'POST',
      body: JSON.stringify(bulkData),
    });
  },

  /**
   * Get attendance records
   * @param {Object} params - Query parameters (date, startDate, endDate, learnerId, classId, status)
   * @returns {Promise} List of attendance records
   */
  getRecords: async (params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/attendance${queryString ? `?${queryString}` : ''}`);
  },

  /**
   * Get attendance statistics
   * @param {Object} params - Query parameters (startDate, endDate, classId, learnerId)
   * @returns {Promise} Attendance statistics
   */
  getStats: async (params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/attendance/stats${queryString ? `?${queryString}` : ''}`);
  },

  /**
   * Get daily class attendance report
   * @param {string} classId - Class ID
   * @param {string} date - Date (YYYY-MM-DD)
   * @returns {Promise} Daily attendance report with all learners
   */
  getDailyClassReport: async (classId, date) => {
    return fetchWithAuth(`/attendance/class/daily?classId=${classId}&date=${date}`);
  },

  /**
   * Get learner attendance summary
   * @param {string} learnerId - Learner ID
   * @param {Object} params - Query parameters (startDate, endDate)
   * @returns {Promise} Learner attendance summary
   */
  getLearnerSummary: async (learnerId, params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/attendance/learner/${learnerId}${queryString ? `?${queryString}` : ''}`);
  },
};

// ============================================
// ASSESSMENTS API
// ============================================

export const assessmentAPI = {
  // ============================================
  // FORMATIVE ASSESSMENTS
  // ============================================

  /**
   * Create or update formative assessment
   * @param {Object} assessmentData - Assessment data
   * @returns {Promise} Created/updated assessment
   */
  createFormative: async (assessmentData) => {
    return fetchWithAuth('/assessments/formative', {
      method: 'POST',
      body: JSON.stringify(assessmentData),
    });
  },

  /**
   * Get all formative assessments with filters
   * @param {Object} params - Query parameters (term, academicYear, learningArea, grade)
   * @returns {Promise} List of formative assessments
   */
  getFormativeAssessments: async (params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/assessments/formative${queryString ? `?${queryString}` : ''}`);
  },

  /**
   * Get formative assessments for a specific learner
   * @param {string} learnerId - Learner ID
   * @param {Object} params - Query parameters (term, academicYear)
   * @returns {Promise} List of learner's formative assessments
   */
  getFormativeByLearner: async (learnerId, params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/assessments/formative/learner/${learnerId}${queryString ? `?${queryString}` : ''}`);
  },

  /**
   * Delete formative assessment
   * @param {string} id - Assessment ID
   * @returns {Promise} Success message
   */
  deleteFormative: async (id) => {
    return fetchWithAuth(`/assessments/formative/${id}`, {
      method: 'DELETE',
    });
  },

  // ============================================
  // SUMMATIVE TESTS
  // ============================================

  /**
   * Create summative test
   * @param {Object} testData - Test data
   * @returns {Promise} Created test
   */
  createTest: async (testData) => {
    return fetchWithAuth('/assessments/tests', {
      method: 'POST',
      body: JSON.stringify(testData),
    });
  },

  /**
   * Bulk create summative tests
   * @param {Object} bulkData - Bulk test data (grades, term, year, etc.)
   * @returns {Promise} Creation summary
   */
  bulkCreateTests: async (bulkData) => {
    return fetchWithAuth('/assessments/tests/bulk', {
      method: 'POST',
      body: JSON.stringify(bulkData),
    });
  },

  /**
   * Get all summative tests with filters
   * @param {Object} params - Query parameters (term, academicYear, grade, learningArea, published)
   * @returns {Promise} List of tests
   */
  getTests: async (params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/assessments/tests${queryString ? `?${queryString}` : ''}`);
  },

  /**
   * Get single test with results
   * @param {string} id - Test ID
   * @returns {Promise} Test data with results and statistics
   */
  getTest: async (id) => {
    return fetchWithAuth(`/assessments/tests/${id}`);
  },

  /**
   * Update summative test
   * @param {string} id - Test ID
   * @param {Object} testData - Updated test data
   * @returns {Promise} Updated test
   */
  updateTest: async (id, testData) => {
    return fetchWithAuth(`/assessments/tests/${id}`, {
      method: 'PUT',
      body: JSON.stringify(testData),
    });
  },

  /**
   * Delete summative test
   * @param {string} id - Test ID
   * @returns {Promise} Success message
   */
  deleteTest: async (id) => {
    return fetchWithAuth(`/assessments/tests/${id}`, {
      method: 'DELETE',
    });
  },

  /**
   * Delete multiple summative tests
   * @param {string[]} ids - Array of test IDs
   * @returns {Promise} Processing summary
   */
  deleteTestsBulk: async (ids) => {
    return fetchWithAuth('/assessments/tests/bulk', {
      method: 'DELETE',
      body: JSON.stringify({ ids }),
    });
  },

  // ============================================
  // SUMMATIVE RESULTS
  // ============================================

  /**
   * Record summative result
   * @param {Object} resultData - Result data (testId, learnerId, marksObtained, remarks, teacherComment)
   * @returns {Promise} Recorded result
   */
  recordResult: async (resultData) => {
    return fetchWithAuth('/assessments/summative/results', {
      method: 'POST',
      body: JSON.stringify(resultData),
    });
  },

  /**
   * Record bulk summative results
   * @param {Object} bulkData - { testId, results: [{ learnerId, marksObtained }] }
   * @returns {Promise} Bulk result
   */
  recordBulkResults: async (bulkData) => {
    return fetchWithAuth('/assessments/summative/results/bulk', {
      method: 'POST',
      body: JSON.stringify(bulkData),
    });
  },

  /**
   * Get summative results for a learner
   * @param {string} learnerId - Learner ID
   * @param {Object} params - Query parameters (term, academicYear)
   * @returns {Promise} List of learner's results
   */
  getSummativeByLearner: async (learnerId, params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/assessments/summative/results/learner/${learnerId}${queryString ? `?${queryString}` : ''}`);
  },

  /**
   * Get all results for a specific test
   * @param {string} testId - Test ID
   * @returns {Promise} List of test results
   */
  async getTestResults(testId) {
    return fetchWithAuth(`/assessments/summative/results/test/${testId}`);
  },

  /**
   * Upload bulk assessments (scores) from Excel/CSV
   * @param {FormData} formData - Contains the file and other parameters
   * @returns {Promise} Upload result summary
   */
  async uploadBulk(formData) {
    return fetchWithAuth('/bulk/assessments/upload', {
      method: 'POST',
      body: formData,
      // Header for FormData is handled automatically by fetch if body is FormData
      headers: {}
    });
  }
};

// ============================================
// FEE MANAGEMENT API
// ============================================

export const feeAPI = {
  /**
   * Get all fee structures
   * @param {Object} params - Query parameters
   * @returns {Promise} Fee structures
   */
  getAllFeeStructures: async (params = {}) => {
    const query = new URLSearchParams(params).toString();
    return fetchWithAuth(`/fees/structures${query ? `?${query}` : ''}`);
  },

  /**
   * Create fee structure
   * @param {Object} data - Fee structure data
   * @returns {Promise} Created fee structure
   */
  createFeeStructure: async (data) => {
    return fetchWithAuth('/fees/structures', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  /**
   * Update fee structure
   * @param {string} id - Fee structure ID
   * @param {Object} data - Updated data
   * @returns {Promise} Updated fee structure
   */
  updateFeeStructure: async (id, data) => {
    return fetchWithAuth(`/fees/structures/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  },

  /**
   * Delete fee structure
   * @param {string} id - Fee structure ID
   * @returns {Promise} Success message
   */
  deleteFeeStructure: async (id) => {
    return fetchWithAuth(`/fees/structures/${id}`, {
      method: 'DELETE',
    });
  },

  /**
   * Get all invoices
   * @param {Object} params - Query parameters
   * @returns {Promise} Invoices
   */
  getAllInvoices: async (params = {}) => {
    const query = new URLSearchParams(params).toString();
    return fetchWithAuth(`/fees/invoices${query ? `?${query}` : ''}`);
  },

  /**
   * Get learner invoices
   * @param {string} learnerId - Learner ID
   * @returns {Promise} Learner invoices
   */
  getLearnerInvoices: async (learnerId) => {
    return fetchWithAuth(`/fees/invoices/learner/${learnerId}`);
  },

  /**
   * Create invoice
   * @param {Object} data - Invoice data
   * @returns {Promise} Created invoice
   */
  createInvoice: async (data) => {
    return fetchWithAuth('/fees/invoices', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  /**
   * Bulk generate invoices
   * @param {Object} data - Bulk generation data
   * @returns {Promise} Created invoices
   */
  bulkGenerateInvoices: async (data) => {
    return fetchWithAuth('/fees/invoices/bulk', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  /**
   * Record payment
   * @param {Object} data - Payment data
   * @returns {Promise} Payment record
   */
  recordPayment: async (data) => {
    return fetchWithAuth('/fees/payments', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  /**
   * Get payment statistics
   * @param {Object} params - Query parameters
   * @returns {Promise} Payment stats
   */
  getPaymentStats: async (params = {}) => {
    const query = new URLSearchParams(params).toString();
    return fetchWithAuth(`/fees/stats${query ? `?${query}` : ''}`);
  },
};

// ============================================
// NOTIFICATIONS API
// ============================================

export const notificationAPI = {
  /**
   * Send assessment completion notification to parent
   * @param {Object} data - { learnerId, assessmentType, subject, grade, term }
   * @returns {Promise} Send result
   */
  sendAssessmentNotification: async (data) => {
    return fetchWithAuth('/notifications/assessment-complete', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  /**
   * Send bulk assessment notifications
   * @param {Object} data - { learnerIds, assessmentType, subject, grade, term }
   * @returns {Promise} Bulk send result
   */
  sendBulkAssessmentNotifications: async (data) => {
    return fetchWithAuth('/notifications/assessment-complete/bulk', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  /**
   * Send custom message to parent
   * @param {Object} data - { parentId, message }
   * @returns {Promise} Send result
   */
  sendCustomMessage: async (data) => {
    return fetchWithAuth('/notifications/custom', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  /**
   * Send announcement to all parents or filtered group
   * @param {Object} data - { title, content, grade, stream }
   * @returns {Promise} Send result
   */
  sendAnnouncement: async (data) => {
    return fetchWithAuth('/notifications/announcement', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  /**
   * Send assessment report via SMS to parent
   * @param {Object} data - Assessment report details
   * @returns {Promise} Send result
   */
  sendAssessmentReportSms: async (data) => {
    return fetchWithAuth('/notifications/sms/assessment-report', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  /**
   * Test WhatsApp connection
   * @param {string} phoneNumber - Phone number to test
   * @returns {Promise} Test result
   */
  testWhatsApp: async (phoneNumber) => {
    return fetchWithAuth('/notifications/test', {
      method: 'POST',
      body: JSON.stringify({ phoneNumber }),
    });
  },
};

// ============================================
// REPORTS API (NEW)
// ============================================

export const reportAPI = {
  /**
   * Get comprehensive formative report for a learner
   * @param {string} learnerId - Learner ID
   * @param {Object} params - { term, academicYear }
   * @returns {Promise} Formative report data
   */
  getFormativeReport: async (learnerId, params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/reports/formative/${learnerId}${queryString ? `?${queryString}` : ''}`);
  },

  /**
   * Get comprehensive summative report for a learner
   * @param {string} learnerId - Learner ID
   * @param {Object} params - { term, academicYear }
   * @returns {Promise} Summative report data
   */
  getSummativeReport: async (learnerId, params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/reports/summative/${learnerId}${queryString ? `?${queryString}` : ''}`);
  },

  /**
   * Get complete termly report (formative + summative + attendance + CBC elements)
   * @param {string} learnerId - Learner ID
   * @param {Object} params - { term, academicYear }
   * @returns {Promise} Complete termly report data
   */
  getTermlyReport: async (learnerId, params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/reports/termly/${learnerId}${queryString ? `?${queryString}` : ''}`);
  },

  /**
   * Get class-level performance analytics
   * @param {string} classId - Class ID
   * @param {Object} params - { term, academicYear }
   * @returns {Promise} Class analytics data
   */
  getClassAnalytics: async (classId, params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/reports/analytics/class/${classId}${queryString ? `?${queryString}` : ''}`);
  },

  /**
   * Get individual learner analytics (year-long progress)
   * @param {string} learnerId - Learner ID
   * @param {Object} params - { academicYear }
   * @returns {Promise} Learner analytics data
   */
  getLearnerAnalytics: async (learnerId, params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/reports/analytics/learner/${learnerId}${queryString ? `?${queryString}` : ''}`);
  },

  /**
   * Generate high-fidelity PDF from HTML
   * @param {Object} data - { html, fileName, options }
   * @returns {Promise<Blob>} PDF Blob
   */
  generatePdf: async (data) => {
    try {
      const response = await axiosInstance.post('/reports/generate-pdf', data, {
        responseType: 'blob'
      });

      const blob = response.data;
      console.log(`✅ PDF Received: ${blob.size} bytes (${blob.type})`);

      if (blob.size < 100) {
        console.warn('⚠️ PDF Blob is suspiciously small');
      }

      return blob;
    } catch (error) {
      console.error('❌ PDF Generation Error:', error);
      throw new Error(error.response?.data?.message || 'PDF Generation failed');
    }
  },
};

// ============================================
// HEALTH CHECK
// ============================================

export const healthAPI = {
  /**
   * Check if backend is reachable
   * @returns {Promise} Health status
   */
  check: async () => {
    try {
      const response = await axiosInstance.get('/health');
      return response.data;
    } catch (error) {
      throw new Error('Backend server is not reachable');
    }
  },
};

// ============================================
// CBC ASSESSMENT API (NEW)
// ============================================

export const cbcAPI = {
  // Core Competencies
  saveCompetencies: async (data) => {
    return fetchWithAuth('/cbc/competencies', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  getCompetencies: async (learnerId, params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/cbc/competencies/${learnerId}${queryString ? `?${queryString}` : ''}`);
  },

  // Values Assessment
  saveValues: async (data) => {
    return fetchWithAuth('/cbc/values', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  getValues: async (learnerId, params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/cbc/values/${learnerId}${queryString ? `?${queryString}` : ''}`);
  },

  // Co-Curricular Activities
  createCoCurricular: async (data) => {
    return fetchWithAuth('/cbc/cocurricular', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  getCoCurricular: async (learnerId, params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/cbc/cocurricular/${learnerId}${queryString ? `?${queryString}` : ''}`);
  },

  updateCoCurricular: async (id, data) => {
    return fetchWithAuth(`/cbc/cocurricular/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  },

  deleteCoCurricular: async (id) => {
    return fetchWithAuth(`/cbc/cocurricular/${id}`, {
      method: 'DELETE',
    });
  },

  // Termly Report Comments
  saveComments: async (data) => {
    return fetchWithAuth('/cbc/comments', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  getComments: async (learnerId, params = {}) => {
    const queryString = new URLSearchParams(params).toString();
    return fetchWithAuth(`/cbc/comments/${learnerId}${queryString ? `?${queryString}` : ''}`);
  },
};

// ============================================
// WORKFLOW API
// ============================================

export const workflowAPI = {
  submit: async (data) => {
    return fetchWithAuth('/workflow/submit', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },
  approve: async (type, id, data = {}) => {
    return fetchWithAuth(`/workflow/approve/${type}/${id}`, {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },
  reject: async (type, id, data) => {
    return fetchWithAuth(`/workflow/reject/${type}/${id}`, {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },
  publish: async (type, id) => {
    return fetchWithAuth(`/workflow/publish/${type}/${id}`, {
      method: 'POST',
    });
  },
  getHistory: async (type, id) => {
    return fetchWithAuth(`/workflow/history/${type}/${id}`);
  },
  approveBulk: async (ids, assessmentType, comments = '') => {
    return fetchWithAuth('/workflow/bulk-approve', {
      method: 'POST',
      body: JSON.stringify({ ids, assessmentType, comments }),
    });
  }
};

// ============================================
// GRADING API
// ============================================

export const gradingAPI = {
  getSystems: async (schoolId) => {
    return fetchWithAuth(`/grading/school/${schoolId}`);
  },

  createSystem: async (data) => {
    return fetchWithAuth('/grading/system', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  updateSystem: async (id, data) => {
    return fetchWithAuth(`/grading/system/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  },

  deleteSystem: async (id) => {
    return fetchWithAuth(`/grading/system/${id}`, {
      method: 'DELETE',
    });
  },

  updateRange: async (id, data) => {
    return fetchWithAuth(`/grading/range/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  },

  createRange: async (data) => {
    return fetchWithAuth('/grading/range', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  deleteRange: async (id) => {
    return fetchWithAuth(`/grading/range/${id}`, {
      method: 'DELETE',
    });
  },

  // Scale Group endpoints
  getScaleGroups: async () => {
    return fetchWithAuth('/grading/scale-groups');
  },

  getScaleGroupById: async (id) => {
    return fetchWithAuth(`/grading/scale-groups/${id}`);
  },

  createScaleGroup: async (data) => {
    return fetchWithAuth('/grading/scale-groups', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  updateScaleGroup: async (id, data) => {
    return fetchWithAuth(`/grading/scale-groups/${id}`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  },

  deleteScaleGroup: async (id) => {
    return fetchWithAuth(`/grading/scale-groups/${id}`, {
      method: 'DELETE',
    });
  },

  generateGradesForGroup: async (id, data) => {
    return fetchWithAuth(`/grading/scale-groups/${id}/generate-grades`, {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },

  getScaleForTest: async (groupId, grade, learningArea) => {
    const params = new URLSearchParams({ grade });
    if (learningArea) params.append('learningArea', learningArea);
    return fetchWithAuth(`/grading/scale-groups/${groupId}/for-test?${params.toString()}`);
  }
};

// ============================================
// ADMIN API
// ============================================
export const adminAPI = {
  getSchoolInfo: async () => {
    return fetchCached('/settings/school-info');
  },
  listSchools: async () => {
    return fetchWithAuth('/admin/schools');
  },
  provision: async (data) => {
    return fetchWithAuth('/admin/schools/provision', {
      method: 'POST',
      body: JSON.stringify(data),
    });
  },
  listPlans: async () => {
    return fetchWithAuth('/admin/plans');
  },
  reactivateSchool: async (schoolId) => {
    return fetchWithAuth(`/admin/schools/${schoolId}/reactivate`, {
      method: 'PATCH',
    });
  },
  approvePayment: async (schoolId, payload) => {
    return fetchWithAuth(`/admin/schools/${schoolId}/approve-payment`, {
      method: 'PATCH',
      body: JSON.stringify(payload || {}),
    });
  },
  trialMetrics: async () => {
    return fetchWithAuth('/admin/trials/metrics');
  },
  getSchoolModules: async (schoolId) => {
    return fetchWithAuth(`/admin/schools/${schoolId}/modules`);
  },
  setSchoolModule: async (schoolId, moduleKey, active) => {
    return fetchWithAuth(`/admin/schools/${schoolId}/modules/${moduleKey}`, {
      method: 'PATCH',
      body: JSON.stringify({ active }),
    });
  },
  switchSchool: async (schoolId) => {
    const resp = await fetchWithAuth(`/admin/switch-school/${schoolId}`, { method: 'POST', headers: { 'X-School-Id': schoolId } });
    return resp;
  },
  getSchoolCommunication: async (schoolId) => {
    return fetchWithAuth(`/admin/schools/${schoolId}/communication`);
  },
  updateSchoolCommunication: async (schoolId, data) => {
    return fetchWithAuth(`/admin/schools/${schoolId}/communication`, {
      method: 'PUT',
      body: JSON.stringify(data),
    });
  },
};
// Export all APIs
const api = {
  auth: authAPI,
  users: userAPI,
  teachers: teacherAPI,
  parents: parentAPI,
  learners: learnerAPI,
  classes: classAPI,
  attendance: attendanceAPI,
  assessments: assessmentAPI,
  reports: reportAPI,
  notifications: notificationAPI,
  fees: feeAPI,
  cbc: cbcAPI,
  health: healthAPI,
  workflow: workflowAPI,
  grading: gradingAPI,
  admin: adminAPI,
};

export default api;
