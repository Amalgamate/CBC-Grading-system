// Prisma Schema - Complete with CBC Assessment Models ADDED
// This file contains ALL CBC models: CoreCompetency, ValuesAssessment, CoCurricularActivity, TermlyReportComment
// BACKUP THE ORIGINAL FIRST BEFORE REPLACING!

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MANAGEMENT & AUTHENTICATION
// ============================================

enum UserRole {
  SUPER_ADMIN      // System owner - full access
  ADMIN            // School administrator
  HEAD_TEACHER     // Senior teacher with oversight
  TEACHER          // Regular classroom teacher
  PARENT           // Parent/guardian (view-only for their children)
  ACCOUNTANT       // Financial officer
  RECEPTIONIST     // Front desk staff
  LIBRARIAN        // Library staff
  NURSE            // School nurse
  SECURITY         // Security personnel
  DRIVER           // Transport driver
  COOK             // Kitchen staff
  CLEANER          // Cleaning staff
  GROUNDSKEEPER    // Grounds maintenance
  IT_SUPPORT       // IT support staff
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id            String      @id @default(uuid())
  email         String      @unique
  username      String?     @unique
  password      String
  firstName     String
  lastName      String
  middleName    String?
  phone         String?
  role          UserRole    @default(TEACHER)
  status        UserStatus  @default(ACTIVE)
  archived      Boolean     @default(false)  // Soft delete for teachers
  archivedAt    DateTime?   // When archived
  archivedBy    String?     // Who archived
  emailVerificationToken String?
  emailVerificationSentAt DateTime?
  phoneVerificationCode String?
  phoneVerificationSentAt DateTime?
  
  // School & Branch Association
  schoolId      String?     // School the user belongs to (null for SUPER_ADMIN)
  school        School?     @relation("SchoolUsers", fields: [schoolId], references: [id], onDelete: SetNull)
  branchId      String?     // Primary branch (null if user has access to all branches)
  branch        Branch?     @relation("BranchUsers", fields: [branchId], references: [id], onDelete: SetNull)
  
  // ID Badge Information
  staffId       String?     @unique // Staff number/employee ID
  profilePicture String?    // Profile picture URL (base64)
  idCardPhoto   String?     // Photo for ID card
  idCardIssued  DateTime?   // When ID was issued
  idCardExpiry  DateTime?   // ID expiry date
  
  lastLogin     DateTime?
  emailVerified Boolean     @default(false)
  
  // Security & Account Management
  loginAttempts Int         @default(0)
  lockedUntil   DateTime?
  passwordResetToken String?
  passwordResetExpiry DateTime?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  // Relations (UPDATED WITH CBC RELATIONS)
  learners                    Learner[]               @relation("ParentLearners")
  classesAsTeacher            Class[]                 @relation("ClassTeacher")
  attendancesMarked           Attendance[]            @relation("AttendanceMarker")
  formativeAssessments        FormativeAssessment[]   @relation("TeacherFormativeAssessments")
  createdTests                SummativeTest[]         @relation("CreatedTests")
  recordedResults             SummativeResult[]       @relation("RecordedResults")
  assessedCoreCompetencies    CoreCompetency[]        @relation("AssessorCoreCompetencies")
  assessedValues              ValuesAssessment[]      @relation("AssessorValues")
  recordedCoCurricular        CoCurricularActivity[]  @relation("RecorderCoCurricular")
  
  // New Relations for Phase 1 (Foundation)
  createdTermConfigs          TermConfig[]
  createdAggregationConfigs   AggregationConfig[]
  submittedTests              SummativeTest[]         @relation("SubmittedTests")
  approvedTests               SummativeTest[]         @relation("ApprovedTests")
  changeHistory               ChangeHistory[]

  // For SummativeResultHistory
  summativeResultHistories    SummativeResultHistory[] @relation("ChangedBy")

  // Support System Relations
  tickets                     SupportTicket[]          @relation("UserTickets")
  assignedTickets             SupportTicket[]          @relation("AssignedTickets")
  sentMessages                SupportMessage[]         @relation("SentMessages")
  
  @@map("users")
  @@index([schoolId])
  @@index([branchId])
}

// ============================================
// ACADEMIC STRUCTURE ENUMS
// ============================================

enum Grade {
  CRECHE
  RECEPTION
  TRANSITION
  PLAYGROUP
  PP1
  PP2
  GRADE_1
  GRADE_2
  GRADE_3
  GRADE_4
  GRADE_5
  GRADE_6
  GRADE_7
  GRADE_8
  GRADE_9
  GRADE_10
  GRADE_11
  GRADE_12
}

// Stream Enum REMOVED in favor of dynamic string handling
// Old enum for reference: A, B, C, D, EAST, WEST, NORTH, SOUTH, RED, BLUE, GREEN, YELLOW

enum LearnerStatus {
  ACTIVE
  TRANSFERRED_OUT
  GRADUATED
  DROPPED_OUT
  SUSPENDED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum Term {
  TERM_1
  TERM_2
  TERM_3
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
  SICK
}

// ============================================
// PHASE 1: NEW ENUMS
// ============================================

enum FormativeAssessmentType {
  OPENER          // Daily/weekly quick test
  WEEKLY          // Weekly assessment
  MONTHLY         // Monthly comprehensive test
  CAT             // Continuous Assessment Test
  MID_TERM        // Mid-term test
  ASSIGNMENT      // Take-home assignment
  PROJECT         // Project-based assessment
  PRACTICAL       // Hands-on/lab work
  QUIZ            // Short quiz
  OBSERVATION     // Teacher observation
  ORAL            // Oral assessment
  EXAM            // Formative exam
  OTHER           // Custom type
}

enum AssessmentStatus {
  DRAFT         // Being created/edited
  SUBMITTED     // Submitted for review
  APPROVED      // Approved by head teacher
  PUBLISHED     // Made visible to students/parents
  LOCKED        // Locked, no further edits allowed
}

enum AggregationStrategy {
  SIMPLE_AVERAGE      // Average all scores
  BEST_N              // Take best N scores only
  DROP_LOWEST_N       // Drop N lowest, average rest
  WEIGHTED_AVERAGE    // Each assessment has different weight
  MEDIAN              // Use median instead of mean
}

enum CurriculumType {
  CBC_ONLY          // Only competency-based
  EXAM_ONLY         // Traditional exam-based
  CBC_AND_EXAM      // Both (most common)
  IGCSE             // International curriculum
  CAMBRIDGE         // Cambridge system
  CUSTOM            // School-defined
}

enum AssessmentMode {
  FORMATIVE_ONLY    // No end-term exams
  SUMMATIVE_ONLY    // Only exams, no continuous assessment
  MIXED             // Both (default)
}

// ============================================
// SCHOOL STATUS ENUM (Multi-tenant lifecycle)
// ============================================
// SchoolStatus removed; use plain string status field

// ============================================
// ADMISSION FORMAT ENUM
// ============================================

enum AdmissionFormatType {
  NO_BRANCH              // ADM-2025-001 (single branch/no branches)
  BRANCH_PREFIX_START    // KB-ADM-2025-001 (branch code at start)
  BRANCH_PREFIX_MIDDLE   // ADM-KB-2025-001 (branch code in middle)
  BRANCH_PREFIX_END      // ADM-2025-001-KB (branch code at end)
}

// ============================================
// SCHOOL MANAGEMENT
// ============================================

model School {
  id                      String                @id @default(uuid())
  name                    String                @unique
  registrationNo          String?               @unique
  address                 String?
  county                  String?
  subCounty               String?
  ward                    String?
  phone                   String?
  email                   String?
  website                 String?
  principalName           String?
  principalPhone          String?
  logoUrl                 String?               // School logo URL or base64
  faviconUrl              String?               // School favicon URL or base64
  schoolType              String?
  motto                   String?               // School motto
  vision                  String?               @db.Text // School vision statement
  mission                 String?               @db.Text // School mission statement
  
  // Admission Format Configuration (set at setup, immutable)
  admissionFormatType     AdmissionFormatType   @default(BRANCH_PREFIX_START)
  branchSeparator         String                @default("-")  // "-" or "_" or ""
  
  // Status
  active                  Boolean               @default(true)
  status                  String                @default("ACTIVE")
  trialStart              DateTime?
  trialDays               Int?                  @default(30)
  
  // NEW: Curriculum configuration (Phase 1)
  curriculumType      CurriculumType   @default(CBC_AND_EXAM)
  assessmentMode      AssessmentMode   @default(MIXED)
  
  // Optional custom grading scale
  customGradingScale  Json?

  archived                Boolean               @default(false)
  archivedAt              DateTime?
  archivedBy              String?

  // Metadata
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  
  // Relations
  branches                Branch[]
  learners                Learner[]
  admissionSequences      AdmissionSequence[]
  users                   User[]                @relation("SchoolUsers")
  scaleGroups             ScaleGroup[]          @relation("SchoolScaleGroups")
  gradingSystems          GradingSystem[]       @relation("SchoolGradingSystems")
  termConfigs             TermConfig[]
  aggregationConfigs      AggregationConfig[]
  streamConfigs           StreamConfig[]
  changeHistory           ChangeHistory[]
  subscriptions           SchoolSubscription[]
  communicationConfig     CommunicationConfig?
  
  // Assessment Relations (Phase 2)
  formativeAssessments    FormativeAssessment[]
  summativeTests          SummativeTest[]
  summativeResults        SummativeResult[]
  feeStructures           FeeStructure[]
  learningAreas           LearningArea[]        @relation("SchoolLearningAreas")
  supportTickets          SupportTicket[]
  
  @@map("schools")
  @@index([county])
}

// ============================================
// SUBSCRIPTION & PLANS (Multi-tenant)
// ============================================
model SubscriptionPlan {
  id            String   @id @default(uuid())
  name          String   @unique
  modules       Json
  maxBranches   Int      @default(1)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  subscriptions SchoolSubscription[]

  @@map("subscription_plans")
}

model SchoolSubscription {
  id            String   @id @default(uuid())
  schoolId      String
  school        School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  planId        String
  plan          SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Restrict)
  startedAt     DateTime @default(now())
  expiresAt     DateTime
  status        String   @default("ACTIVE") // ACTIVE, EXPIRED, CANCELED
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("school_subscriptions")
  @@index([schoolId])
  @@index([planId])
}

// ============================================
// BRANCH MANAGEMENT
// ============================================

model Branch {
  id              String    @id @default(uuid())
  
  // References
  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Branch Details
  name            String            // e.g., "Nairobi Campus", "Mombasa Branch"
  code            String            // e.g., "KB", "MB" - used in admission numbers
  address         String?
  phone           String?
  email           String?
  principalName   String?
  
  // Status
  active          Boolean   @default(true)
  archived        Boolean   @default(false)
  archivedAt      DateTime?
  archivedBy      String?
  
  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  learners        Learner[]
  classes         Class[]
  users           User[]    @relation("BranchUsers")
  
  // Assessment Relations (Phase 2)
  formativeAssessments    FormativeAssessment[]
  summativeTests          SummativeTest[]
  summativeResults        SummativeResult[]
  feeStructures           FeeStructure[]
  
  // Unique constraint: branch code must be unique per school
  @@unique([schoolId, code])
  @@map("branches")
  @@index([schoolId])
  @@index([code])
}

// ============================================
// ADMISSION SEQUENCE MANAGEMENT
// ============================================

model AdmissionSequence {
  id              String    @id @default(uuid())
  
  // References
  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Sequence Configuration (school-wide, shared across all branches)
  academicYear    Int
  currentValue    Int       @default(0)
  
  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Unique constraint per school per academic year (school-wide sequence)
  @@unique([schoolId, academicYear])
  @@map("admission_sequences")
  @@index([schoolId])
  @@index([academicYear])
}

// ============================================
// CLASS MODEL
// ============================================

model Class {
  id          String     @id @default(uuid())
  
  // Branch Assignment
  branchId    String
  branch      Branch     @relation(fields: [branchId], references: [id], onDelete: Cascade)
  
  name        String     // e.g., "Grade 1 A", "PP1 East"
  grade       Grade
  stream      String?
  
  // Teacher Assignment
  teacherId   String?
  teacher     User?      @relation("ClassTeacher", fields: [teacherId], references: [id])
  
  // Academic Year & Term
  academicYear Int       @default(2025)
  term        Term      @default(TERM_1)
  
  // Class Details
  capacity    Int       @default(40)
  room        String?
  
  // Status
  active      Boolean   @default(true)
  archived    Boolean   @default(false)
  archivedAt  DateTime?
  archivedBy  String?
  
  // Metadata
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  enrollments ClassEnrollment[]
  attendances Attendance[]
  
  @@unique([branchId, grade, stream, academicYear, term])
  @@map("classes")
  @@index([branchId])
  @@index([teacherId])
  @@index([grade, stream])
}

// ============================================
// CLASS ENROLLMENT (Link Learners to Classes)
// ============================================

model ClassEnrollment {
  id          String    @id @default(uuid())
  
  // References
  classId     String
  class       Class     @relation(fields: [classId], references: [id], onDelete: Cascade)
  learnerId   String
  learner     Learner   @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  
  // Enrollment Details
  enrolledAt  DateTime  @default(now())
  active      Boolean   @default(true)
  
  @@unique([classId, learnerId])
  @@map("class_enrollments")
  @@index([classId])
  @@index([learnerId])
  @@index([learnerId, active])
  @@index([classId, active])
}

// ============================================
// LEARNER MODEL
// ============================================

model Learner {
  id                String          @id @default(uuid())
  
  // School & Branch Scope
  schoolId          String
  school            School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  branchId          String
  branch            Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  
  // Admission Information
  admissionNumber   String
  
  // Personal Information
  firstName         String
  lastName          String
  middleName        String?
  dateOfBirth       DateTime
  gender            Gender
  photoUrl          String?         // Student photo URL (base64 or cloud URL)
  photoPublicId     String?         // For cloud storage tracking
  
  // Academic Information
  grade             Grade
  stream            String?
  
  // Parent/Guardian Information
  parentId          String?
  parent            User?           @relation("ParentLearners", fields: [parentId], references: [id])
  guardianName      String?
  guardianPhone     String?
  guardianEmail     String?
  
  // Medical & Emergency Information
  medicalConditions String?
  allergies         String?
  emergencyContact  String?
  emergencyPhone    String?
  bloodGroup        String?
  
  // Address Information
  address           String?
  county            String?
  subCounty         String?
  
  // Academic Status
  status            LearnerStatus   @default(ACTIVE)
  admissionDate     DateTime        @default(now())
  exitDate          DateTime?
  exitReason        String?
  
  // Additional Information
  previousSchool    String?
  religion          String?       // Christianity, Islam, Hindu, SDA, Buddhist, Other
  specialNeeds      String?
  
  // ID Card Information
  idCardIssued      DateTime?     // When ID was issued
  idCardExpiry      DateTime?     // ID expiry date
  idCardNumber      String?       // Unique ID card number
  
  // Metadata
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  createdBy         String?
  updatedBy         String?
  archived          Boolean         @default(false)
  archivedAt        DateTime?
  archivedBy        String?
  
  // Relations (UPDATED WITH CBC RELATIONS)
  enrollments           ClassEnrollment[]
  attendances           Attendance[]
  formativeAssessments  FormativeAssessment[]
  summativeResults      SummativeResult[]
  feeInvoices           FeeInvoice[]              @relation("LearnerInvoices")
  coreCompetencies      CoreCompetency[]          @relation("LearnerCoreCompetencies")
  valuesAssessments     ValuesAssessment[]        @relation("LearnerValues")
  coCurricularActivities CoCurricularActivity[]   @relation("LearnerCoCurricular")
  reportComments        TermlyReportComment[]     @relation("LearnerReportComments")
  smsAudits             AssessmentSmsAudit[]      @relation("LearnerSmsAudits")
  
  // Unique constraint: admission number scoped per school (not per branch)
  // This ensures no duplicates across all branches of a school
  @@unique([schoolId, admissionNumber])
  @@map("learners")
  @@index([schoolId])
  @@index([branchId])
  @@index([admissionNumber])
  @@index([parentId])
  @@index([grade, stream])
  @@index([status])
  @@index([lastName, firstName])
  @@index([schoolId, grade, stream, status])
}

// ============================================
// ATTENDANCE MODEL
// ============================================

model Attendance {
  id          String            @id @default(uuid())
  
  // References
  learnerId   String
  learner     Learner           @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  
  classId     String?
  class       Class?            @relation(fields: [classId], references: [id], onDelete: SetNull)
  
  // Attendance Data
  date        DateTime          @db.Date
  status      AttendanceStatus  @default(PRESENT)
  remarks     String?
  
  // Metadata
  markedAt    DateTime          @default(now())
  markedBy    String
  teacher     User              @relation("AttendanceMarker", fields: [markedBy], references: [id])
  
  @@unique([learnerId, date])
  @@map("attendances")
  @@index([date])
  @@index([learnerId])
  @@index([classId])
  @@index([status])
}

// ============================================
// ASSESSMENT MODELS (CBC System)
// ============================================

enum RubricRating {
  EE  // Exceeds Expectations (General)
  ME  // Meets Expectations (General)
  AE  // Approaches Expectations (General)
  BE  // Below Expectations (General)
}

// Detailed 8-level CBC Rubric Rating
enum DetailedRubricRating {
  EE1  // Exceeds Expectations 1 - Outstanding (90-100%) - 8 points
  EE2  // Exceeds Expectations 2 - Very High (75-89%) - 7 points
  ME1  // Meets Expectations 1 - High Average (58-74%) - 6 points
  ME2  // Meets Expectations 2 - Average (41-57%) - 5 points
  AE1  // Approaches Expectations 1 - Low Average (31-40%) - 4 points
  AE2  // Approaches Expectations 2 - Below Average (21-30%) - 3 points
  BE1  // Below Expectations 1 - Low (11-20%) - 2 points
  BE2  // Below Expectations 2 - Very Low (1-10%) - 1 point
}

enum SummativeGrade {
  A   // 80-100%
  B   // 60-79%
  C   // 50-59%
  D   // 40-49%
  E   // 0-39%
}

enum TestStatus {
  PASS
  FAIL
}

enum ModerationStatus {
  PENDING     // Awaiting review by moderator
  APPROVED    // Approved by moderator
  REJECTED    // Rejected by moderator, needs revision
  DRAFT       // Initial state, not yet submitted for moderation
}

// ============================================
// FORMATIVE ASSESSMENT
// ============================================

model FormativeAssessment {
  id                String        @id @default(uuid())
  
  // Learner Reference
  learnerId         String
  learner           Learner       @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  
  // Academic Period
  term              Term          @default(TERM_1)
  academicYear      Int           @default(2026)
  
  // Learning Area Details
  learningArea      String        // "Mathematics", "English", "Kiswahili", etc.
  strand            String?       // Specific strand within learning area
  subStrand         String?       // More specific sub-topic
  
  // CBC Rubric Assessment (4-level system)
  overallRating     RubricRating  // Overall performance: EE, ME, AE, BE
  
  // Detailed CBC Rubric (8-level system) - RECOMMENDED
  detailedRating    DetailedRubricRating?  // Specific level: EE1, EE2, ME1, ME2, AE1, AE2, BE1, BE2
  points            Int?          // Points earned (1-8) based on detailed rating
  percentage        Float?        // Calculated percentage (0-100)
  
  // Detailed Competency Tracking (Optional - for detailed tracking)
  exceedingCount    Int           @default(0)  // Number of EE ratings
  meetingCount      Int           @default(0)  // Number of ME ratings
  approachingCount  Int           @default(0)  // Number of AE ratings
  belowCount        Int           @default(0)  // Number of BE ratings
  
  // Teacher Feedback
  strengths         String?       @db.Text
  areasImprovement  String?       @db.Text
  remarks           String?       @db.Text
  recommendations   String?       @db.Text
  
  // Teacher Reference
  teacherId         String
  teacher           User          @relation("TeacherFormativeAssessments", fields: [teacherId], references: [id])
  
  // New Fields for Phase 1 (Foundation)
  type              FormativeAssessmentType @default(OPENER)
  status            AssessmentStatus        @default(DRAFT)
  title             String?                 // e.g., "Week 1 Opener"
  date              DateTime?               @default(now())
  maxScore          Float?                  // Max possible score
  weight            Float                   @default(1.0) // Weight in aggregation
  locked            Boolean                 @default(false) // If true, no further edits allowed
  lockedAt          DateTime?
  lockedBy          String?

  // TENANT FIELDS (PHASE 2)
  schoolId          String
  school            School      @relation(fields: [schoolId], references: [id])
  branchId          String?
  branch            Branch?     @relation(fields: [branchId], references: [id])
  archived          Boolean     @default(false)
  archivedAt        DateTime?
  archivedBy        String?
  
  @@index([schoolId])
  @@index([branchId])

  // Metadata
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Adjusted constraint to allow multiple assessments per term/subject
  // Uniqueness is now based on ID, but we enforce uniqueness on (learner, term, subject, type, title) to prevent duplicates if title is provided
  @@unique([learnerId, term, academicYear, learningArea, type, title])
  @@map("formative_assessments")
  @@index([learnerId])
  @@index([teacherId])
  @@index([term, academicYear])
  @@index([learningArea])
  @@index([learnerId, learningArea, term, academicYear])
}

// ============================================
// SUMMATIVE TEST
// ============================================

model SummativeTest {
  id              String          @id @default(uuid())
  
  // Test Details
  title           String          // "End of Term 1 Mathematics"
  learningArea    String          // "Mathematics", "English", etc.
  testType        String?         // NEW: Test grouping (OPENER, MIDTERM, END_TERM, MONTHLY, WEEKLY, RANDOM)
  
  // Academic Period
  term            Term            @default(TERM_1)
  academicYear    Int             @default(2026)
  grade           Grade           // Which grade is this test for
  
  // Test Configuration
  testDate        DateTime        @db.Date
  totalMarks      Int             // e.g., 100
  passMarks       Int             // e.g., 50
  duration        Int?            // Duration in minutes
  
  // Additional Info
  description     String?         @db.Text
  instructions    String?         @db.Text
  
  // Creator
  createdBy       String
  creator         User            @relation("CreatedTests", fields: [createdBy], references: [id])
  
  // Status
  published       Boolean         @default(false)
  active          Boolean         @default(true)
  status          AssessmentStatus @default(DRAFT)
  
  // Phase 1: Workflow & Config
  curriculum      CurriculumType  @default(CBC_AND_EXAM)
  weight          Float           @default(100.0) // Contribution to final grade
  locked          Boolean         @default(false) // If true, no further edits allowed
  lockedAt        DateTime?
  lockedBy        String?
  statusHistory   Json[]          @default([])
  
  // Workflow
  submittedBy     String?
  submittedAt     DateTime?
  submittedByUser User?           @relation("SubmittedTests", fields: [submittedBy], references: [id])
  
  approvedBy      String?
  approvedAt      DateTime?
  approvedByUser  User?           @relation("ApprovedTests", fields: [approvedBy], references: [id])
  
  // Scale / Grading System
  scaleId         String?
  scale           GradingSystem?  @relation(fields: [scaleId], references: [id])

  // Results
  results         SummativeResult[]
  
  // TENANT FIELDS (PHASE 2)
  schoolId          String
  school            School      @relation(fields: [schoolId], references: [id])
  branchId          String?
  branch            Branch?     @relation(fields: [branchId], references: [id])
  
  @@index([schoolId])
  @@index([branchId])
  @@index([testType])             // NEW: Index for fast test grouping queries
  @@index([schoolId, grade, learningArea, term])

  // Metadata
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  archived        Boolean         @default(false)
  archivedAt      DateTime?
  archivedBy      String?
  
  @@map("summative_tests")
  @@index([grade, term, academicYear])
}

// ============================================
// PHASE 1: NEW MODELS
// ============================================

model TermConfig {
  id              String        @id @default(uuid())
  
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  academicYear    Int
  term            Term
  
  startDate       DateTime
  endDate         DateTime
  
  // Weights (e.g., Formative 30%, Summative 70%)
  formativeWeight Float         @default(30.0)
  summativeWeight Float         @default(70.0)
  
  // Status
  isActive        Boolean       @default(false)
  isClosed        Boolean       @default(false)
  
  createdBy       String
  creator         User          @relation(fields: [createdBy], references: [id])
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@unique([schoolId, academicYear, term])
  @@map("term_configs")
}

model AggregationConfig {
  id              String        @id @default(uuid())
  
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  grade           Grade?        // Apply to specific grade (optional, null = all)
  learningArea    String?       // Apply to specific subject (optional, null = all)
  
  type            FormativeAssessmentType
  strategy        AggregationStrategy     @default(SIMPLE_AVERAGE)
  
  // Strategy Parameters
  nValue          Int?          // For BEST_N or DROP_LOWEST_N
  weight          Float         @default(1.0)
  
  createdBy       String
  creator         User          @relation(fields: [createdBy], references: [id])
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@map("aggregation_configs")
}

model ChangeHistory {
  id              String        @id @default(uuid())
  
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  entityType      String        // e.g., "SummativeResult", "FormativeAssessment"
  entityId        String
  action          String        // CREATE, UPDATE, DELETE
  
  field           String?       // Specific field changed
  oldValue        String?       // Serialized old value
  newValue        String?       // Serialized new value
  
  changedBy       String
  changer         User          @relation(fields: [changedBy], references: [id])
  
  changedAt       DateTime      @default(now())
  reason          String?
  
  @@map("change_history")
  @@index([schoolId])
  @@index([entityType, entityId])
}

// ============================================
// SUMMATIVE RESULT
// ============================================

model SummativeResult {
  id              String          @id @default(uuid())
  
  // Test Reference
  testId          String
  test            SummativeTest   @relation(fields: [testId], references: [id], onDelete: Cascade)
  
  // Learner Reference
  learnerId       String
  learner         Learner         @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  
  // Marks and Performance
  marksObtained   Int
  percentage      Float           // Auto-calculated: (marksObtained / totalMarks) * 100
  grade           SummativeGrade  // A, B, C, D, E
  status          TestStatus      // PASS or FAIL
  moderationStatus ModerationStatus @default(DRAFT) // New: Moderation workflow status
  
  // Position/Rank
  position        Int?            // Position in class
  outOf           Int?            // Total students who took test
  
  // Feedback
  remarks         String?         @db.Text
  teacherComment  String?         @db.Text
  
  // Recorder
  recordedBy      String
  recorder        User            @relation("RecordedResults", fields: [recordedBy], references: [id])
  
  // TENANT FIELDS (PHASE 2)
  schoolId          String
  school            School      @relation(fields: [schoolId], references: [id])
  branchId          String?
  branch            Branch?     @relation(fields: [branchId], references: [id])
  
  // History of changes to this result
  resultHistory   SummativeResultHistory[]

  @@index([schoolId])
  @@index([branchId])
  @@index([moderationStatus]) // New index for moderation status

  // Metadata
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  archived        Boolean         @default(false)
  archivedAt      DateTime?
  archivedBy      String?
  
  @@unique([testId, learnerId])
  @@map("summative_results")
  @@index([testId])
  @@index([learnerId])
  @@index([grade])
  @@index([status])
  @@index([testId, grade, marksObtained])
}

model SummativeResultHistory {
  id              String        @id @default(uuid())
  resultId        String        // Reference to the SummativeResult that was changed
  result          SummativeResult @relation(fields: [resultId], references: [id])

  // Details of the change
  action          String        // e.g., "CREATE", "UPDATE", "DELETE"
  field           String?       // Specific field changed (e.g., "marksObtained", "remarks")
  oldValue        String?       @db.Text // JSON string of the old value
  newValue        String?       @db.Text // JSON string of the new value
  
  changedBy       String        // ID of the user who made the change
  changer         User          @relation("ChangedBy", fields: [changedBy], references: [id])
  
  changeTimestamp DateTime      @default(now())
  reason          String?       @db.Text // Optional reason for the change

  @@map("summative_result_history")
  @@index([resultId])
  @@index([changedBy])
  @@index([changeTimestamp])
}

// ============================================
// CBC-SPECIFIC ASSESSMENT MODELS (NEW)
// ============================================

// Core Competencies Assessment (CBC Requirement)
model CoreCompetency {
  id              String        @id @default(uuid())
  
  // Learner Reference
  learnerId       String
  learner         Learner       @relation("LearnerCoreCompetencies", fields: [learnerId], references: [id], onDelete: Cascade)
  
  // Academic Period
  term            Term
  academicYear    Int
  
  // Six Core Competencies with detailed ratings
  communication        DetailedRubricRating
  communicationComment String?  @db.Text
  
  criticalThinking        DetailedRubricRating
  criticalThinkingComment String?  @db.Text
  
  creativity        DetailedRubricRating
  creativityComment String?  @db.Text
  
  collaboration        DetailedRubricRating
  collaborationComment String?  @db.Text
  
  citizenship        DetailedRubricRating
  citizenshipComment String?  @db.Text
  
  learningToLearn        DetailedRubricRating
  learningToLearnComment String?  @db.Text
  
  // Assessor
  assessedBy      String
  assessor        User          @relation("AssessorCoreCompetencies", fields: [assessedBy], references: [id])
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@unique([learnerId, term, academicYear])
  @@map("core_competencies")
  @@index([learnerId])
  @@index([term, academicYear])
}

// Values Assessment (CBC Requirement)
model ValuesAssessment {
  id              String        @id @default(uuid())
  
  // Learner Reference
  learnerId       String
  learner         Learner       @relation("LearnerValues", fields: [learnerId], references: [id], onDelete: Cascade)
  
  // Academic Period
  term            Term
  academicYear    Int
  
  // Seven National Values
  love            DetailedRubricRating
  responsibility  DetailedRubricRating
  respect         DetailedRubricRating
  unity           DetailedRubricRating
  peace           DetailedRubricRating
  patriotism      DetailedRubricRating
  integrity       DetailedRubricRating
  
  // General Comment
  comment         String?       @db.Text
  
  // Assessor
  assessedBy      String
  assessor        User          @relation("AssessorValues", fields: [assessedBy], references: [id])
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  archived        Boolean       @default(false)
  archivedAt      DateTime?
  archivedBy      String?
  
  @@unique([learnerId, term, academicYear])
  @@map("values_assessments")
  @@index([learnerId])
  @@index([term, academicYear])
}

// Co-Curricular Activities
model CoCurricularActivity {
  id              String        @id @default(uuid())
  
  // Learner Reference
  learnerId       String
  learner         Learner       @relation("LearnerCoCurricular", fields: [learnerId], references: [id], onDelete: Cascade)
  
  // Academic Period
  term            Term
  academicYear    Int
  
  // Activity Details
  activityName    String                    // Football, Drama, Choir, etc.
  activityType    String                    // Sports, Arts, Clubs, etc.
  performance     DetailedRubricRating      // Performance rating
  achievements    String?       @db.Text    // Competitions, awards, etc.
  remarks         String?       @db.Text
  
  // Recorder
  recordedBy      String
  recorder        User          @relation("RecorderCoCurricular", fields: [recordedBy], references: [id])
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  archived        Boolean       @default(false)
  archivedAt      DateTime?
  archivedBy      String?
  
  @@map("co_curricular_activities")
  @@index([learnerId])
  @@index([term, academicYear])
  @@index([activityType])
}

// Termly Report Comments
model TermlyReportComment {
  id              String        @id @default(uuid())
  
  // Learner Reference
  learnerId       String
  learner         Learner       @relation("LearnerReportComments", fields: [learnerId], references: [id], onDelete: Cascade)
  
  // Academic Period
  term            Term
  academicYear    Int
  
  // Class Teacher Comment
  classTeacherComment    String   @db.Text
  classTeacherName       String
  classTeacherSignature  String?  // Base64 or URL
  classTeacherDate       DateTime
  
  // Head Teacher Comment
  headTeacherComment     String?  @db.Text
  headTeacherName        String?
  headTeacherSignature   String?
  headTeacherDate        DateTime?
  
  // Parent/Guardian Acknowledgment
  parentComment          String?  @db.Text
  parentSignature        String?
  parentDate             DateTime?
  
  // Next Term Details
  nextTermOpens          DateTime
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@unique([learnerId, term, academicYear])
  @@map("termly_report_comments")
  @@index([learnerId])
  @@index([term, academicYear])
}

// ============================================
// ID CARD MANAGEMENT
// ============================================

model IDCardTemplate {
  id                String        @id @default(uuid())
  
  // Template Details
  templateName      String        @unique
  templateType      IDCardType    // STUDENT or STAFF
  
  // Template Design (HTML/CSS or image)
  templateDesign    String        @db.Text  // HTML template or base64 image
  templateCSS       String?       @db.Text  // Optional CSS for HTML templates
  
  // Layout Configuration (JSON)
  layoutConfig      Json?         // {photoPosition: {x: 10, y: 20}, namePosition: {}, etc}
  
  // Dimensions
  width             Int           @default(320)  // pixels or mm
  height            Int           @default(204)  // pixels or mm
  orientation       String        @default("horizontal") // horizontal or vertical
  
  // Template Settings
  showPhoto         Boolean       @default(true)
  showBarcode       Boolean       @default(true)
  showQRCode        Boolean       @default(false)
  
  // Branding
  schoolLogo        String?       // Logo URL or base64
  backgroundColor   String        @default("#FFFFFF")
  textColor         String        @default("#000000")
  
  // Status
  isActive          Boolean       @default(false)
  isDefault         Boolean       @default(false)
  
  // Metadata
  createdBy         String
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  archived          Boolean       @default(false)
  archivedAt        DateTime?
  archivedBy        String?
  
  @@map("id_card_templates")
}

enum IDCardType {
  STUDENT
  STAFF
  VISITOR
  TEMPORARY
}

// ============================================
// FEE MANAGEMENT
// ============================================

enum FeeType {
  TUITION
  TRANSPORT
  MEALS
  ACTIVITY
  UNIFORM
  BOOKS
  EXAM
  LATE_PAYMENT
  OTHER
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  OVERPAID
  WAIVED
}

enum PaymentMethod {
  CASH
  MPESA
  BANK_TRANSFER
  CHEQUE
  CARD
}

model FeeStructure {
  id              String    @id @default(uuid())
  
  // Fee Details
  name            String    // e.g., "Grade 1 Term 1 Fees"
  description     String?   @db.Text
  feeType         FeeType
  amount          Decimal   @db.Decimal(10, 2)
  
  // Applicable To
  grade           Grade?
  term            Term?
  academicYear    Int
  
  // Tenant Scoping
  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  branchId        String?
  branch          Branch?   @relation(fields: [branchId], references: [id])
  
  // Status
  active          Boolean   @default(true)
  mandatory       Boolean   @default(true)
  
  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       String
  archived        Boolean   @default(false)
  archivedAt      DateTime?
  archivedBy      String?
  
  // Relations
  invoices        FeeInvoice[]
  
  @@map("fee_structures")
  @@index([grade, term, academicYear])
  @@index([feeType])
}

model FeeInvoice {
  id                String        @id @default(uuid())
  invoiceNumber     String        @unique
  
  // Student Reference
  learnerId         String
  learner           Learner       @relation("LearnerInvoices", fields: [learnerId], references: [id], onDelete: Cascade)
  
  // Fee Structure Reference
  feeStructureId    String
  feeStructure      FeeStructure  @relation(fields: [feeStructureId], references: [id])
  
  // Invoice Details
  term              Term
  academicYear      Int
  dueDate           DateTime
  
  // Amounts
  totalAmount       Decimal       @db.Decimal(10, 2)
  paidAmount        Decimal       @db.Decimal(10, 2) @default(0)
  balance           Decimal       @db.Decimal(10, 2)
  
  // Status
  status            PaymentStatus @default(PENDING)
  
  // Metadata
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  issuedBy          String
  archived          Boolean       @default(false)
  archivedAt        DateTime?
  archivedBy        String?
  
  // Relations
  payments          FeePayment[]
  
  @@map("fee_invoices")
  @@index([learnerId])
  @@index([term, academicYear])
  @@index([status])
  @@index([dueDate])
}

model FeePayment {
  id                String        @id @default(uuid())
  receiptNumber     String        @unique
  
  // Invoice Reference
  invoiceId         String
  invoice           FeeInvoice    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  
  // Payment Details
  amount            Decimal       @db.Decimal(10, 2)
  paymentMethod     PaymentMethod
  paymentDate       DateTime      @default(now())
  
  // Payment Reference
  referenceNumber   String?       // M-Pesa code, cheque number, etc.
  notes             String?       @db.Text
  
  // Metadata
  createdAt         DateTime      @default(now())
  recordedBy        String
  
  @@map("fee_payments")
  @@index([invoiceId])
  @@index([paymentDate])
  @@index([paymentMethod])
}

// ============================================
// COMMUNICATION SYSTEM
// ============================================

enum MessageType {
  EMAIL
  WHATSAPP
  SMS
  IN_APP
}

enum MessageStatus {
  DRAFT
  SENT
  DELIVERED
  READ
  FAILED
}

enum RecipientType {
  INDIVIDUAL
  CLASS
  GRADE
  ALL_PARENTS
  ALL_TEACHERS
  CUSTOM
}

model Message {
  id              String          @id @default(uuid())
  
  // Sender
  senderId        String
  senderType      UserRole
  
  // Recipients
  recipientType   RecipientType
  recipientIds    String[]        // Array of user IDs
  
  // Message Content
  subject         String?
  body            String          @db.Text
  messageType     MessageType     @default(IN_APP)
  
  // Scheduling
  scheduledFor    DateTime?       // If null, send immediately
  sentAt          DateTime?
  
  // Status
  status          MessageStatus   @default(DRAFT)
  
  // Attachments
  attachments     Json?           // Array of file URLs
  
  // Metadata
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  receipts        MessageReceipt[]
  
  @@map("messages")
  @@index([senderId])
  @@index([status])
  @@index([messageType])
  @@index([scheduledFor])
}

model MessageReceipt {
  id              String          @id @default(uuid())
  
  // Message Reference
  messageId       String
  message         Message         @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  // Recipient
  recipientId     String
  recipientEmail  String?
  recipientPhone  String?
  
  // Delivery Status
  status          MessageStatus   @default(SENT)
  deliveredAt     DateTime?
  readAt          DateTime?
  failureReason   String?
  
  // Metadata
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@map("message_receipts")
  @@index([messageId])
  @@index([recipientId])
  @@index([status])
}
// ============================================
// GRADING SYSTEM CONFIGURATION
// ============================================

// Scale Group Model - Groups related grading systems
model ScaleGroup {
  id            String          @id @default(uuid())
  name          String          // "Zawadi Internal Exams", "End of Term Exams"
  description   String?         @db.Text
  
  // Scope
  schoolId      String
  school        School          @relation("SchoolScaleGroups", fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Status
  active        Boolean         @default(true)
  isDefault     Boolean         @default(false)
  
  // Relations
  gradingSystems GradingSystem[] @relation("ScaleGroupSystems")
  
  // Metadata
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  archived      Boolean         @default(false)
  archivedAt    DateTime?
  archivedBy    String?
  
  @@unique([schoolId, name])
  @@map("scale_groups")
  @@index([schoolId])
}

model GradingSystem {
  id            String      @id @default(uuid())
  name          String      // e.g. "Grade 1 - All Subjects"
  type          String      // "SUMMATIVE" or "CBC"
  
  // Scale Group association
  scaleGroupId  String?
  scaleGroup    ScaleGroup? @relation("ScaleGroupSystems", fields: [scaleGroupId], references: [id])
  
  // Grade and subject specific scales
  grade         Grade?   
  learningArea  String?     // NULL = applies to ALL learning areas

  // Scope
  schoolId      String
  school        School      @relation("SchoolGradingSystems", fields: [schoolId], references: [id], onDelete: Cascade)
  
  active        Boolean     @default(true)
  archived      Boolean     @default(false)
  archivedAt    DateTime?
  archivedBy    String?
  isDefault     Boolean     @default(false)
  
  ranges        GradingRange[]
  summativeTests SummativeTest[]
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@map("grading_systems")
  @@index([schoolId])
  @@index([scaleGroupId])
  @@index([grade])
}

model GradingRange {
  id              String        @id @default(uuid())
  
  systemId        String
  system          GradingSystem @relation(fields: [systemId], references: [id], onDelete: Cascade)
  
  label           String        // "A", "EE1"
  minPercentage   Float
  maxPercentage   Float
  
  // Mapping to Enums (Optional but helpful for type safety in code)
  summativeGrade  SummativeGrade?
  rubricRating    DetailedRubricRating?
  
  points          Int?          // 4, 3, 2, 1 or 8, 7, 6...
  color           String?       // Hex code
  description     String?       // "Exceeds Expectations"
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  archived        Boolean       @default(false)
  archivedAt      DateTime?
  archivedBy      String?
  
  @@map("grading_ranges")
  @@index([systemId])
}

// ============================================
// STREAM CONFIGURATION (Dynamic Streams)
// ============================================

model StreamConfig {
  id              String    @id @default(uuid())
  
  // References
  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Stream Details
  name            String    // e.g., "A", "Blue", "Eagle"
  
  // Status
  active          Boolean   @default(true)
  
  // Metadata
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Unique constraint: Stream name must be unique per school
  @@unique([schoolId, name])
  @@map("stream_configs")
  @@index([schoolId])
}

model CommunicationConfig {
  id              String    @id @default(uuid())
  
  // School Reference (One config per school)
  schoolId        String    @unique
  school          School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // SMS Configuration
  smsProvider     String?   @default("mobilesasa") // "mobilesasa" | "custom"
  smsApiKey       String?   // Encrypted API key
  smsBaseUrl      String?   @default("https://api.mobilesasa.com")
  smsSenderId     String?   // Max 11 characters (e.g., "ZAWADI")
  smsEnabled      Boolean   @default(false)
  hasApiKey       Boolean   @default(false) // Helper flag for frontend to know if key is set

  // SMS Custom Provider Settings
  smsCustomName       String?
  smsCustomBaseUrl    String?
  smsCustomAuthHeader String? // Header name (e.g. "Authorization", "api-key")
  smsCustomToken      String? // Encrypted token

  // Email Configuration
  emailProvider   String?   @default("resend") // "resend" | "smtp"
  emailApiKey     String?   // Encrypted
  emailFrom       String?
  emailFromName   String?
  emailEnabled    Boolean   @default(false)
  emailTemplates  Json?     // Stores custom subjects and bodies for 'welcome', 'onboarding', etc.

  // M-Pesa Configuration
  mpesaProvider   String?   @default("intasend") // "intasend" | "sasepay"
  mpesaPublicKey  String?   // Encrypted
  mpesaSecretKey  String?   // Encrypted
  mpesaBusinessNo String?   // Paybill/Till
  mpesaEnabled    Boolean   @default(false)
  
  // Birthday Configuration
  birthdayEnabled         Boolean   @default(false)
  birthdayMessageTemplate String?   @default("Happy Birthday {learnerName}! Best wishes from {schoolName}.")

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("communication_configs")
}

// ============================================
// ASSESSMENT SMS AUDIT (Parent Notifications)
// ============================================

model AssessmentSmsAudit {
  id                    String      @id @default(uuid())
  
  // Learning context
  learnerId             String
  learner               Learner     @relation("LearnerSmsAudits", fields: [learnerId], references: [id], onDelete: Cascade)
  
  // Assessment context
  assessmentId          String?
  assessmentType        String      // FORMATIVE, SUMMATIVE, CORE_COMPETENCY, VALUES
  
  // Recipient details
  parentId              String?
  parentPhone           String      // Normalized (254712345678)
  parentName            String?
  learnerName           String
  learnerGrade          String
  
  // CBC-specific content
  competencyName        String?     // Communication, Critical Thinking, etc.
  achievementLevel      String?     // Exceeding, Achieving, Developing
  subStrand             String?     // Specific area in competency
  templateType          String      // FORMATIVE_EXCEEDING, SUMMATIVE_TERM, ALERT_CRITICAL, etc.
  
  // Message tracking
  messageContent        String      @db.Text // Full SMS text (for audit)
  smsMessageId          String?     // MobileSasa API response ID
  reportLink            String?     // Shortened URL to parent portal
  
  // Delivery status
  smsStatus             String      // QUEUED, SENT, DELIVERED, FAILED, BOUNCED
  sentAt                DateTime    @default(now())
  deliveredAt           DateTime?
  failureReason         String?     // "Invalid phone", "Quota exceeded", etc.
  
  // Audit trail
  sentByUserId          String?     // Teacher/Admin who triggered send
  cooldownExpiry        DateTime?   // When next SMS to this parent allowed
  
  // Relationships
  schoolId              String
  
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  
  @@index([learnerId])
  @@index([parentPhone])
  @@index([sentAt])
  @@index([smsStatus])
  @@index([schoolId])
  @@map("assessment_sms_audits")
}

// ============================================
// LEARNING AREAS & CURRICULUM
// ============================================

model LearningArea {
  id            String      @id @default(uuid())
  name          String      // Full name (e.g., "Mathematics", "English Language")
  shortName     String?     // Abbreviated name
  gradeLevel    String      // Grade level category (e.g., "Lower Primary", "Upper Primary")
  icon          String      @default("")
  color         String      @default("#3b82f6")
  description   String?
  
  // School Association
  schoolId      String?     // NULL = applies to all schools
  school        School?     @relation("SchoolLearningAreas", fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  
  @@unique([schoolId, name])
  @@index([gradeLevel])
  @@index([schoolId])
  @@map("learning_areas")
}

// ============================================
// SUPPORT & CHAT SYSTEM
// ============================================

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model SupportTicket {
  id            String         @id @default(uuid())
  subject       String
  priority      TicketPriority @default(MEDIUM)
  status        TicketStatus   @default(OPEN)
  
  // Who opened the ticket
  userId        String?
  user          User?          @relation("UserTickets", fields: [userId], references: [id], onDelete: SetNull)
  
  // Guest Details (if not logged in)
  guestName     String?
  guestEmail    String?
  
  // Which school (usually context, optional as SUPER_ADMIN might open one)
  schoolId      String?
  school        School?        @relation(fields: [schoolId], references: [id], onDelete: SetNull)

  // Assigned Staff (Super Admin)
  assignedToId  String?
  assignedTo    User?          @relation("AssignedTickets", fields: [assignedToId], references: [id])

  messages      SupportMessage[]
  
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@map("support_tickets")
  @@index([userId])
  @@index([schoolId])
  @@index([status])
}

model SupportMessage {
  id            String        @id @default(uuid())
  message       String        @db.Text
  
  ticketId      String
  ticket        SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  
  senderId      String?
  sender        User?          @relation("SentMessages", fields: [senderId], references: [id])
  
  read          Boolean       @default(false)
  readAt        DateTime?
  
  createdAt     DateTime      @default(now())
  
  @@map("support_messages")
  @@index([ticketId])
  @@index([senderId])
}
